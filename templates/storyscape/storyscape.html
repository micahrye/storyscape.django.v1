{% extends "base.html" %}

{% block title %}StoryScape{% endblock %}

{% block external_style %}
  <link type="text/css" rel="stylesheet" 
        href="{{ STATIC_URL }}js/jpaginate/css/style.css" />
  <link href="{{ STATIC_URL }}js/jquery-context-menu/jquery.contextMenu.css" rel="stylesheet" 
        type="text/css" />
 <link rel='stylesheet' type='text/css'
       href='{{ STATIC_URL }}js/bgrins-spectrum/spectrum.css' />
  <link type="text/css" rel="stylesheet" 
        href="{{ STATIC_URL }}storyscape_static/storyline_navigation.css" />
  <link type="text/css" rel="stylesheet" 
        href="{{ STATIC_URL }}storyscape_static/side_control_panel.css" />
  <link rel="stylesheet" type="text/css"
      href="{{ STATIC_URL }}js/reveal/reveal.css" />
{% endblock %}

{% block inline_style %}
<style>
#footer{ margin-top: 100px; }

#reveal-div{ 
}
.highlight{ 
  color:blue ; 
  font-weight: bold; 
} 
#upload-image-form, #upload-image-form input {
  margin: auto;
  width: 250px;
}
.font-name{ 
  font-size:xx-small;
  font-color:red;
  background-color:red;
}
#content-wrapper{ height:1240px; } 

#storyscape-container { 
  width:1024px;
} 

#builder-pane {
  position:relative;
  margin-top:15px;
  margin-left:12px; /* MRE WAS 15 */
  width: 704px; /* 800 is 0.625 of true width 1280 */ 
  height: 440px; /* 500 is 0.625 of true height 800 */
  border: solid #ccc 1px; /* add this pixel value to top/left below */
  background-color:white;
}

.draggable {
    /* solves issue with safari/chrome drag offset */
/*    position: absolute !important; */
}

.flip-horizontal {
  -moz-transform: scaleX(-1);
  -webkit-transform: scaleX(-1);
  -o-transform: scaleX(-1);
  transform: scaleX(-1);
  filter: fliph; /*IE*/
}

#properties-form label.error {
  color: red;
  margin-left: 10px;
  width: auto; 
  display: inline;
  font-size: 0.8em;
}


.small-text {
  font-size: 0.75em; 
} 

.ss-button {
  outline: 0; 
  margin:0 0 0 0; 
  padding: 0; 
  text-decoration:none !important; 
  cursor:pointer; 
  /*position: relative; */
  text-align: center; 
  zoom: 1;
  font-size: .8em !important; 
}

.mini-thumb {
  height:52px;width:52px;
  margin:3px 10px;
  background-color:white;
  padding: 5px;
  border-radius: 5px;
  border:solid #ccc 1px;
  box-shadow: 0 0 5px #ccc;
  float:left;
}
.mini-thumb-img-box {
  width:50px;height:50px;
  display:inline-block;
  cursor:pointer;
  position:relative;
  border:solid #ccc 1px;
}
.mini-thumb-img {
 display:block;margin:auto;
 max-width:100%;max-height:100%;
}
.on-page {
 border:solid #FF8300 1px;
}

.thumb {
  height: 102px;
  width:102px;
  margin:0px 0 10px 7px;
  z-index:100;
}
.thumb-img-box {
  width:100px;
  height:100px;
}
.thumb-img {
  display:block;
  margin:auto;
  max-width:100%;max-height:120px;
}

#mediabox {
  width:992px;
  height:650px;
  /*border:dashed #ccc 1px;*/
  margin-top:0px;
  margin-left:auto; 
  margin-right:auto;
  background-color:white;
  border:solid 1px #ccc; 
}
#thumb-wrapper {
  width:990px;
    margin-left:10px;
}
.textbox {
  z-index:500;
  border:solid #ccc 1px;
  float:left;
  top:650px;left:720px;
  width:250px;
  position:fixed;
}

#add-btn {
  font-size:30px;
  font-weight:900;
  background-color:#ccc;color:#808080;
  height:32px;width:32px;
  line-height:30px;
  margin-left:5px;
}
#add-btn:hover {
  box-shadow:0 0 3px #808080;
}


.focus {
  border:solid red 1px !important;
}

.connection {
  border:solid green 1px !important;
}
.delete-pbmo {
  position:absolute;
  top:0;right:0;
  background-color:#ccc;
  color:#808080;
  font-weight:900;
  padding:5px;
    height:8px;
  line-height:8px;
  border-radius:0 0 0 3px;
  cursor:pointer;
}
.delete-pbmo:hover {
  padding:6px;
}

.delete-thumb-btn {
  position:absolute;
  top:0;right:0;
  color:#808080;
  font-weight:900;
  padding:5px;
    height:8px;
  line-height:8px;
  border-radius:0 3px 0 0;
    border:solid #808080 1px;
  cursor:pointer;
}

.add-thumb-btn {
  position:absolute;
  bottom:0;left:0;
  color:#808080;
  font-weight:900;
  padding:5px;
    height:9px;
  line-height:9px;
  border-radius:0 3px 0 0;
    border:solid #808080 1px;
  cursor:pointer;
}
.add-thumb-btn:hover, .delete-thumb-btn:hover {
  padding:6px;
    color:black;
}
.mini {
  padding:3px;
}
.mini:hover {
  padding:4px;
}

.pb-media-object {
  cursor:move;
}
.text-box{ 
  padding:0; 
  z-index:500; 
  font-size:24; 
  display:inline-block; 
}

.mo-action, #animation-run {
   margin-left:2px;
   color: black; 
   border:solid #808080 1px;
   padding:1px;
}
#mo-goto{
  margin-top:3px;
  width:3em; 
  height:1.35em;
  resize:none; 
  
} 
#animation-run:hover{
  font-weight:bold;
}
#user-stories-list{
  padding:0px; 
} 
#user-stories-list li{ 
  border-bottom:solid #ccc 1px; 
  list-style-type: none;
} 
.toolbar-item {
  cursor:pointer;
}
.no-border {
    border: none; 
}
.table-heading {
  cursor:default;
}

#font-size-controls-wrapper{ 
}
#font-size-controls{
} 
#font-size-selector{
  float:left;
}

.ss-btn {
  width:25px;height:250px;
  position:relative;
}
.ss-btn-wrapper {
  width:27px;height:25px;
  overflow:hidden;
}

.form-item {
  padding: 3px 0 3px 2px; 
  float:left;
  min-width:200px; 
}
.form-item-focus {
  border:solid #ccc 1px !important;
}
.properties-text, .properties-text:active, .properties-text:focus,
.create-text, .create-text:active, .create-text:focus {
  border:solid white 1px;background:none;
  font-family: Arial, 'sans-serif';
  resize:none;
  max-width:155px;
  height:20px;
  line-height:20px;
  padding: 3px;
  outline:none;
  color: #DC5919;
}
.error{ 
  color: red;
}
#story-properties-tags, #story-properties-title, #story-properties-author, 
#story-properties-genre, #story-properties-desc {
    color:black;
  font-weight:bold;
  font-size:1em;
}
#story-properties-tags{ 
  min-height:40px; 
  width:171px;
}
#create-story-tags {
  min-height:40px;
  min-width:200px;
}
#cancel-create-story-btn {
    float:right; 
    margin-right:4px;
}
#create-story-form, #story-properties-form{
  display:none;
} 
#create-story-btn {
    float:left; 
    margin-left:0px;
}
#update-story-btn {
  margin-top:7px;
  margin-left:5px;
}
.create-text, .create-text:active, .create-text:focus {
  border:solid #9F9F9F 1px;
  /*border:solid #DC5919 1px;*/
}
#create-story-title, #create-story-author, #create-story-genre, 
#story-properties-title, #story-properties-author, #story-properties-genre, 
#story-properties-tags { 
  color: #DC5919;
  font-weight:bold;
  font-size:1em;
  min-width:200px;
}
#prop-story-desc, #story-properties-desc, #create-story-desc {
  min-height:80px;
  min-width:200px;
}
#prop-story-tags-wrapper, #create-story-tags-wrapper {
  min-height:55px;
  cursor:text;
  width:158px;
  margin-left:2px;margin-top:3px;
}
#prop-story-genre, #create-story-genre {
  margin-right:0px;
  margin-top:-2px;
}

#toolbar-wrapper {
  left:64px;
}
#toolbar-content {
}
.color {
  width:20px;height:20px;
  margin:2px;
  float:left;
  border:solid #ccc 1px;
}
.color-hover, .color-focus {
  cursor:pointer;
  border:solid #808080 1px;
}
.color-focus {
 box-shadow:0 0 5px #808080;
}

#small-text, #large-text {
 margin:0 5px;
 height:35px;width:35px;line-height:10px;
 border:solid white 1px;
 font-weight:bold;
}
#small-text {font-size:25px;}
#large-text {font-size:25px;}
.text-btn {
 font-size:9px; font-weight:normal;float:left;
 padding:0 8px;margin-right:3px;
}
#text-border {
 position:relative;
}

#progressbar-wrapper{ 
  height:20px;
  width:924px;
}
#progressbar {
  height:15px;
}

#feedback-btn{ float:right; margin-right:40px;  } 

@font-face {
   font-family: whitehall;
   src: local(whitehall), url('{{ STATIC_URL }}fonts/whitehall.ttf') format('truetype');
}
@font-face {
   font-family: appleberry;
   src: local(appleberry), url('{{ STATIC_URL }}fonts/appleberry_with_cyrillic.ttf') format('truetype');
}

@font-face {
   font-family: quirky;
   src: local(quirky), url('{{ STATIC_URL }}fonts/JandaQuirkygirl.ttf') format('truetype');
}
@font-face {
   font-family: silly;
   src: local(silly), url('{{ STATIC_URL }}fonts/JandaSillyMonkey.ttf') format('truetype');
}
@font-face {
   font-family: wildflowers;
   src: local(wildflowers), url('{{ STATIC_URL }}fonts/Of_Wildflowers_and_Wings.ttf') format('truetype');
}
@font-face {
   font-family: stary_night;
   src: local(stary_night), url('{{ STATIC_URL }}fonts/One_Stary_Night.ttf') format('truetype');
}
@font-face {
   font-family: shine;
   src: local(shine), url('{{ STATIC_URL }}fonts/Where_Stars_Shine_the_Brightest.ttf') format('truetype');
}
@font-face {
   font-family: cinnamon;
   src: local(cinnamon), url('{{ STATIC_URL }}fonts/cinnamon_cake.ttf') format('truetype');
}
/* modify global.css */

</style>
{% endblock %}

{% block external_javascript %}
  <script src="{{ STATIC_URL }}js/jpaginate/jquery.paginate.js" 
          type="text/javascript">
  </script>
  <script src="{{ STATIC_URL }}js/jquery-context-menu/jquery.contextMenu.js" 
          type="text/javascript"> 
  </script>
  <script src="{{ STATIC_URL }}/storyscape_static/js/pageBuilder.js" 
          type="text/javascript"> 
  </script>
  <script src='{{ STATIC_URL }}js/bgrins-spectrum/spectrum.js'
          type='text/javascript'> 
  </script>

  <script src="{{ STATIC_URL }}/storyscape_static/js/animation-utility.js" 
          type="text/javascript"> 
  </script>
  <script src="{{ STATIC_URL }}/js/jquery-validation-1.9.0/jquery.validate.js" 
          type="text/javascript"> 
  </script>
<!-- http://code.google.com/p/jqueryrotate/wiki/Examples --> 
  <script src="{{ STATIC_URL }}js/jquery-rotate/jquery-rotate.2.2.js" 
          type="text/javascript">
  </script>  
  <script src="{{ STATIC_URL }}js/reveal/jquery.reveal.js" 
          type="text/javascript">
  </script>
{% endblock %}

{% block inline_javascript %}
<script type="text/javascript">
// startjquery
$(function(){
 
  /* Critical to make sure that the scale factors match 
     the css values for the builder pane width and height. */
  var user = $('#user').attr('name');
  var curStory = {'title':'', 'genre':'', 'desc':'', 'author':'', 
                  'tags':'', 'numPages':0, 'storyId':-1}; 
  curStory['author'] = $("#user").attr('name');
  var userStories = []; 
  var curMediaObjects = [{}]
  //1280x800 default size 
  var scaleDown = 0.55; //704/1280 when width set to 704x440
  var scaleUp = 8/4.4;  // 1280/704
  // should match #builder-pane
  var paneMaxWidth = 704; //IMPORTANT: Micah check that size ratios between builder/mobile device. 
  var paneMaxHeight = 440; 
  var pageNumber = 1; 
  
  var url = $('#url-info').val(); 
  $("#dev-output").text(url); 
   
  configAjaxSend();
  $(".draggable").draggable(); 
  
  // scirpt included 
  $("#builder-pane").pageBuilder({'maxHeight':paneMaxHeight, 
                         'minHeight':48, 'maxWidth':paneMaxWidth, 'minWidth':48});  

  function MediaObject(type){
    //CURRENTLY TYPE CAN BE 'image', OR 'text', 
    //BUT NEED SERVER CODE FOR THIS
    this.story_id = 0;            
    this.type = type; 
    this.page_number = 0; 
    this.name = ''; 
    // there is a difference between mediaobject ids and 
    // pagemediaobject ids... 
    this.mo_id = -1; 
    this.pmo_id = -1; 
    this.xcoor = 0; this.ycoor = 0; 
    this.width = 0; this.height = 0; 
    this.z_index = 0; 
    this.http_src = ''; 
    this.goto_page = -1;
    this.trigger_reaction_on = 0; 
    this.reaction_object = 'none'; 
    this.anime_code = '';
    //IMPORTANT: hardcoded to zero now, need to add option for how 
    // a user wants an action to happen. 
    // 0='no action', 1='on touch', 2='on sound'
    this.animate_on = 0; 
    this.on_anime_text = ''; 
    this.text = ''; 
    //TODO: need to add in font style, color, size vars
    this.font_style = 'sans_serif';
    this.font_color = '#ff000000'; //black
    this.font_size = '48'; //assumes scale for reader 1200x800
  }
 
  // SET color from color picker to text object 
  $("#color-input").spectrum({
    color: "#000",
    showInput: true,
    change: function(color) {
        $('#text-entry').css('color', color.toHexString());
        $('.text-box.focus').css('color', color.toHexString()); 
    }
  });

  //convert css color value to hex color value in string form 
  function colorToHex(color){
    var m = /rgba?\((\d+), (\d+), (\d+)/.exec(color);
    c = m ? ( m[1] << 16 | m[2] << 8 | m[3] ).toString(16) : color;
    if( m[1] == "0" && m[2] != "0" )
        c = "#00" + c;
    else if( m[1] == "0" && m[2] == "0" )
        c = "#0000" + c;
    else
        c = "#" + c;
    return c;
  }
   
  var curPageSaved = [];  
  /* function moToJSON 
     convert javascript media objects to JSON to send to 
     server
  */
  function moToJSON() {
    re = new RegExp("^/media/"); 
    var moArray = new Array();
    // each iterorates over objects in order so we can use that 
    // to assign z-index 
    var zIndex = 0; 
    $(".pb-media-object").each(function(indx, el){
       /* NEED to make sure and take care of error conditions
          like values bellow zero or above dimension max.
       */
       mo = new MediaObject($(el).attr('media-type')); 
       cWidth = $(el).width(); 
       cHeight = $(el).height(); 
       curTop = $(el).parent().position().top; 
       curLeft =$(el).parent().position().left; 
       mo.ycoor = curTop * scaleUp; 
       mo.xcoor = curLeft * scaleUp; 
       mo.width = (cWidth * scaleUp); 
       mo.height = (cHeight * scaleUp);
       mo.z_index = zIndex++; 
       mo.mo_id = $(el).attr('mo-id'); 
       mo.pmo_id = $(el).attr('pmo-id'); 
       
       //CHECKING TYPE OF MO - NEED TO ADD CODE FOR SERVER
       if(mo.type=='image') {
         mo.http_src = $(el).attr('src').replace(re, ""); 
         tmp = mo.http_src.split('/');
         mo.name = tmp[tmp.length-1];
       }else if(mo.type=='text') {
         var htmlText = $(el).html().replace(/\s+/g,' '); 
         mo.text = htmlText.replace(/<br>/g,'&#10;')
         // mo.text=$(el).val();
         //There should never be an odd font size, always 
         mo.font_size = Math.ceil( parseInt($(el).css('font-size'))*scaleUp ); 
         mo.font_color = colorToHex($(el).css('color')); 
         mo.font_style = $(el).attr('fstyle'); 
         curTop = $(el).position().top; 
         curLeft =$(el).position().left; 
         mo.ycoor = curTop * scaleUp; 
         mo.xcoor = curLeft * scaleUp; 
       }
       mo.story_id = curStory['storyId']; 
       // might want to have a html elem display page number also
       mo.page_number = curPage; 
       mo.animate_on = $(el).attr('animate-on') == undefined 
                       ? 0 : $(el).attr('animate-on');
       mo.anime_code = $(el).attr('anime-code') == undefined 
                       ? 0 : $(el).attr('anime-code');
       mo.goto_page = $(el).attr('goto-page') == undefined 
                       ? -1 : $(el).attr('goto-page');
       mo.trigger_reaction_on = $(el).attr('trigger-reaction-on') == undefined 
                       ? 0 : $(el).attr('trigger-reaction-on')
       if( $(el).attr('reaction-object') == undefined ||
           $(el).attr('reaction-object') == "" ){
         mo.reaction_object = 'none';
       }else{
         mo.reaction_object = $(el).attr('reaction-object'); 
       }
       moArray.push(mo); 
       //if page not in curStroyPages needs to be added !!! no matter 
       //what need to update curStoryPages, since info may have changes. 
    });// end each(...
   return moArray;  
  }

  //TODO: FIX should pass page that is being saved, need to move away from 
  // global curPage... 
  function savePage(){
    // IMPORTANT:  SHOULD have check if page modifed save, otherwise
    // dont make ajax call
    // your should not be able to save empty pages
    unfocusPageBuilder();
    var pageMediaObjects = moToJSON();
    curStoryPages[curPage]['media_objects'] = pageMediaObjects;   
    
    if( pageMediaObjects.length == 0 ){
      //alert("Page empty, nothing to save. Start building your page!");
      return 0; 
    }
    
    pData = $.toJSON(pageMediaObjects); 
    $.ajax({
        type: "POST",
        url: url, 
        data: {PAGE_SAVE: pData}, 
        success: function(data){ 
            msg = data;
            //TODO: This is a bug, if ajax call slow curPage can change!!!
            //TODO: FIX should pass page number being saved and return 
            // that to update curPageSaved array 
            curPageSaved[curPage] = true; 
        }, 
        error: function(data){ 
            msg = 'error saving'; 
            alert(msg);
        }
    }); 
  }// end savePage( 
  
  function createPage(){
    savePage();
    //remove any current media objects  
    $('.pb-media-object').remove();
    if(curStoryPages.length == 0){
      alert("You must first open or create a new story");
      return;
    }
    //TODO: shouldn't this be in the on success in ajax
    //TODO: FIX want to reduce use of global curPage
    for (i=++curPage;i<curStoryPages.length;i++) {
      ++curStoryPages[i]['page_number'];
    }
    curStoryPages.splice(curPage, 0, {'page_number': curPage, 
                        'media_objects':[] } ); 
    curPageSaved.splice(curPage, 0, false ); 
    curMediaObjects.splice(curPage, 0, {});
    $('#current-page-number').text(curPage);
    updateTotalNumberPages(curStoryPages.length);
    updateCurrentPageNav(curPage+1);  
    
    addPageToGotoSelector(curPage+1); 
  
    $.ajax({
       type: 'POST',
       url: url,
       data: {NEW_PAGE: curPage, STORY_ID: curStory['storyId']},
       dataType: "JSON",
       success: function(dataJSON) {
       },
       error: function(dataJSON) {
        alert("couldn't save it");
       }
    });
  }
  
  function deletePage(){
    if( confirm("Are you sure you want to delete this page?") ){
     $.ajax({
      type: "POST",
      url: url,
      data: {DELETE_PAGE: curPage, STORY_ID: curStory['storyId']},
      dataType: "JSON",
      success: function(dataJSON) {
       alert(dataJSON);
       curStoryPages.splice(curPage, 1);
       curMediaObjects.splice(curPage, 1);
       curPageSaved.splice(curPage, 1);
       if (curPage>=curStoryPages.length) {
        --curPage;
       }
       updateTotalNumberPages(curStoryPages.length);
       layoutStoryPage(curPage);
                   deletePageFromGotoSelector(); 
      },
      error: function(dataJSON) {
       alert('nope');
      }
     });
    }
  }
  
  var validateMsg = "Required Field";
  var messager = function(){
      return validateMsg;
  }; 
  var createFormValidator = $('#create-story-form').validate({ 
                             onfocusout:false, onkeyup: false,} ); 
  
  $.validator.addMethod('story-form-item', 
    function(value, elem){ 
      //TODO: may want to add more validation checks
      var isValid = true;
      if( $(elem).attr('name') == 'title'){
        $('.user-story-info').each(function(){
          if($(this).text().trim()== $(elem).val() ) {
            $(elem).css({'border':'solid red 1px' }); 
            validateMsg = 'Title already exist, must be unique'; 
            isValid = false;
          }
        });
      }else if( $(elem).val() != $(elem).attr('default-text') ){
        $(elem).css({'border':'solid #9F9F9F 1px' }); 
        isValid = true; 
      }else{ 
        $(elem).css({'border':'solid red 1px' }); 
        validateMsg = 'Required Field'; 
        isValid = false; 
      }
        return isValid;
  }, messager); //end validator
 
  $('#create-story-btn').click( 
                        {'form':$('#create-story-form')[0]}, 
                        createStory ); 
  
  $('#cancel-create-story-btn').on('click', 
       {form: $('#create-story-form')[0]}, 
       function(event){
         event.data.form.reset();
         $('#create-story-form').dialog('close');
       }
  ); 

  $('#update-story-btn').click(
                  {'form':$('#story-properties-form')[0]}, 
                   saveStoryProps ); 
   
  function createStory(event) {
        valid = $('#create-story-form').validate().form(); 
        if( !valid )
            return 0;
        var form = event.data.form;
        var sData = storyProps($(form));
        
        var jsonData = $.toJSON(sData); 
        // CREATE NEW STORY 
        $.ajax({
            type: "POST",
            url: url, 
            data: {STORY_CREATION: jsonData}, 
            success: function(jsonData){ 
                //want to clear the form
                form.reset(); 
                data = $.evalJSON(jsonData); 
                
                story = $.evalJSON(data['story_json'])[0]; 
                
                // Add new story to list of your stories 
                //if(data['result'] == 'created'){
                    alert(data['msg']); 
                    userStories.push(story); 
                    var index = userStories.length - 1; 


            $('#user-stories-list').
               prepend("<li class='user-story-info toolbar-item' "+
                       " story-index='"+index+"'>"+
                       userStories[index]['title']+"</li>"); 
                //if media object on page remove them
                //remove any objects in the builder pane
                loadStory(index);
                curStoryPages[0] = {'page_number':0, 
                                    'media_objects':[]}; 
                curPageSaved = []; 
                curPageSaved[0] = false;
            }, 
            error: function(data){ 
                  msg = 'error saving' 
                  alert(msg + data); 
                }
            }); 
  
  }
  
  function getUserStories(){
    $.ajax({
      type: "GET",
      url: url, 
      data: {USER_STORIES: "True"},
      //dataType: 'json',
      success: function(data){
          //NOTE: we are getting the stories and meta data
          //COULD also do this on page load with django templates
          userStories = $.evalJSON(data); 
          num = userStories.length; 
          $('#stories-toolbar').siblings().find('.toolbar-content').empty();
          for(i = 0; i < num; i++){
            $('#user-stories-list').
               prepend("<li class='user-story-info toolbar-item' "+
                       " story-index='"+i+"'>"+
                       userStories[i]['title']+"</li>"); 
          }
          loadStory(num-1);
      }, 
      error: function(data){
          alert('problem getting user stories'); 
      }
    }); 
  }
  
  $(document).on('click', '.user-story-info', 
      function(evt){
        evt.preventDefault();
        loadStory(parseInt(evt.currentTarget.getAttribute('story-index')));
        //close open story dialog
        $('#user-stories').dialog('close');
      }
  );
  
  getUserStories(); 
  var curStoryPages = []; 
  function getStoryPages(curStory){
      id = curStory['storyId'];
    $.ajax({
      type: "GET",
      url: url, 
      data: {STORY_PAGE: 'ALL', STORY_ID: curStory['storyId']},
      //dataType: 'json',
      success: 
        function(data){
          curStoryPages = [];
          curMediaObjects = [{}];
          storyPages = $.evalJSON(data); 
          numPages = storyPages.length; 
          if( numPages == 0 ){
            $('.pb-media-object').remove();
            curStoryPages[0] = {'page_number':0, 
                                 'media_objects':[]}; 
            updateTotalNumberPages(curStoryPages.length);
            updateGotoSelector(curStoryPages.length); 
            curPage = 0; 
            updateCurrentPageNav(curPage + 1);
            return;
          }
          
          updateTotalNumberPages(numPages);
          updateGotoSelector(numPages); 

          tmp = {}
          curPageSaved = [];
          for(j = 0; j < numPages; j++){
            tmp['page_number'] = storyPages[j]['page_number']; 
            tmp['media_objects'] = pageMediaObjectsFromJSON(
                                         curStory['storyId'], 
                                         tmp['page_number'], 
                                         storyPages[j]['media_objects_json']);
            // add page to curent story pages
            // need to account for story with no pages yet
            curStoryPages[j] = tmp; 
            curPageSaved[j] = true; 
            
            getPmos(j);
            
            tmp = {}; 
          }
          layoutStoryPage(curPage = 0); 
          setGotoSelector(-1); 
      }, 
      error: function(data){
          alert('problem getting user stories'); 
      }
    }); 
  }
  
  function getPmos(numPage){
  var mos = {};
  for (k = 0; k < tmp['media_objects'].length; k++) {
   mos[tmp['media_objects'][k]['id']] = tmp['media_objects'][k]['http_src'];
  }
  curMediaObjects[numPage] = mos;
 }
  
  function pageMediaObjectsFromJSON(storyId, pageNumber, moJSON){
     pmos = []; 
     pmoj = $.evalJSON(moJSON);     
     num_objs = pmoj.length
     for(i = 0; i < num_objs; i++){
       var pmo = null; 
       if (pmoj[i]['fields']['media_type'] == 'image') {
         pmo = new MediaObject('image');
         src = pmoj[i]['fields']['media_object']['fields']['url']; 
         pmo.http_src = pmoj[i]['fields']['media_object']['fields']['url']; 
         pmo.mo_id = pmoj[i]['fields']['media_object']['pk']; 
         pmo.pmo_id = pmoj[i]['pk']; 
       }else if(pmoj[i]['fields']['media_type'] == 'text'){
         pmo = new MediaObject('text');
         pmo.pmo_id = pmoj[i]['pk']; 
         pmo.text = pmoj[i]['fields']['assoc_text']
         pmo.font_style = pmoj[i]['fields']['font_style']
         pmo.font_size = pmoj[i]['fields']['font_size']
         pmo.font_color = pmoj[i]['fields']['font_color']
       }
       pmo.story_id = storyId;
       pmo.xcoor = pmoj[i]['fields']['xcoor']; 
       pmo.ycoor = pmoj[i]['fields']['ycoor']; 
       pmo.width = pmoj[i]['fields']['width']; 
       pmo.height = pmoj[i]['fields']['height']; 
       pmo.goto_page = pmoj[i]['fields']['goto_page']; 
       // MRE start of adding trigger/reaction 
       pmo.trigger_reaction_on = pmoj[i]['fields']['trigger_reaction_on']; 
       pmo.reaction_object = pmoj[i]['fields']['reaction_object']; 
       pmo.anime_code = pmoj[i]['fields']['anime_code']; 
       pmo.animate_on = pmoj[i]['fields']['animate_on']; 
       pmo.page_number = pageNumber; 
       pmo.on_anime_text = ""; 
       pmos[i] = pmo;  
     }
     return pmos; 
  }
   
  function shareStory(){
      //NEED TO MAKE SURE STORY IS SAVED AND ALL PAGES ARE SAVED 
      //TODO: error checking to make sure storyId is correct and that
      // all data is saved...

      /* IMPORTANT: 
         you should not be able to have empty pages in your 
         story...all pages should have been saved alread...
      */
   var confirmShare = confirm("Published stories will be available for " +
                            "download by the StoryScape reader. You can also " + 
                            "browse published stories in the library. " +
                            "Press 'Ok' to publish your story." );
      if( confirmShare ){ 
        $('#progress-dialog').dialog('open');    
        $('#progressbar').css('visibility', 'visible');
        $('#progressbar').progressbar(
          {value:false  } ); 
        $.ajax({
              type: "POST",
              url: url, 
              data: {SHARE_STORY: curStory['storyId']}, 
              success: function(data){ 
                  msg = data; 
                  $('#progress-dialog').dialog('close');    
                  $('#progressbar').progressbar('destroy');
              }, 
              error: function(data){ 
                  msg = 'Error creating media for sharing story.'; 
                  //TODO: create log here or on server side so 
                  //admin know...
                  alert(data);
              }
        });         
      }
  }// end shareStory

  function layoutStoryPage(pageNumber){
    //TODO make this check better, temp fix only
    if(!validPageNumber(pageNumber))
        return 0;
    var pmos = curStoryPages[pageNumber]['media_objects'];
    var numObjs = pmos.length;
    //remove any objects in the builder pane
    $(".pb-media-object").remove(); 
    for(i = 0; i < numObjs; i++){
      var pmo = pmos[i] 
      var width = pmo['width'] * scaleDown;  
      var height = pmo['height'] * scaleDown; 
      var ycoor = (pmo['ycoor'] * scaleDown) + 'px' ; 
      var xcoor = (pmo['xcoor'] * scaleDown) + 'px' ; 
      var pmo_id = pmo['pmo_id']; 
      var text = pmo['text']
      //IMPORTANT add font color, style, size here and below 
      if (pmo.type == 'image'){
        var elem = "<img class='media-object' pane='false' media-type='image' "+
        " mo-id="+pmo['mo_id']+" mediaobject-url="+pmo['http_src']+ 
        " pmo-id="+pmo_id+
        " src=/media/"+pmo['http_src']+ " " +
        "anime-code="+pmo['anime_code'] + " " +
        "animate-on="+pmo['animate_on'] + " " +
        "goto-page="+pmo['goto_page'] + " " +
        "trigger-reaction-on=" + pmo['trigger_reaction_on'] + " " + 
        "reaction-object=" + pmo['reaction_object'] + " " + 
        "width="+width+ " height="+height+
        " />"
        var clone = addElement($(elem));
        $(clone).parent().css('top', ycoor) ;
        $(clone).parent().css('left', xcoor) ; 
      }else if(pmo.type == 'text') {

        var elem = $("<div class='text-box'"+
                                " fstyle='sans_serif' " + 
           "pmo-id='-1' color='black' media-type='text'></div>");
        elem.html(text.replace(/&#10;/g, '<br/>')); 
        $(elem).css('color', pmo['font_color']); 
        $(elem).css('font-size', Math.floor(parseInt(pmo['font_size'])*scaleDown) )
        var clone = addElement($(elem));
        $(clone).css('top', ycoor) ;
        $(clone).css('left', xcoor) ; 
      }
      unfocusPageBuilder();
    }
    updateCurrentPageNav(pageNumber + 1);
    setAnimationSelector(0); 
    setTriggerSelector(0); 
    setFontSizeSelector(18); 
    $('#text-entry').text(''); 
    $('#text-entry').val(''); 
    return true; 
  }
  

  var curentStory = null; 
  function loadStory(storyIndex){
    story = userStories[storyIndex]; 
    //TODO: probably best to change these globals and instead 
    // pass variable to populatePropertiesDialog(); 
    curStory['storyId'] = story['story_id']
    curStory['author'] = story['author_name']; 
    curStory['title'] = story['title']; 
    curStory['genre'] = story['genre']; 
    curStory['desc'] = story['description']; 
    curStory['numPages'] = story['num_pages']; 
    curStory['tags'] = story['tags']
    curMediaObjects = [];
     
    populatePropertiesDialog(curStory);  
    // now load first page of story into buillder pany
    getStoryPages(curStory);  
    
  }//end loadStory
  
  $('#create-story-form').validate({
      
      messages: {
        title: "Please enter a story title", 
        author: 'Please enter story author', 
        genre: 'Please enter story genre', 
        description: 'Please enter story description',
        tags: 'Please enter a descriptive tag',
      } 
  }); // end validate
  
  //make sure it is clear from refreash or old data
  $('#properties-form').find("input[type=text], textarea").val("")
  
  // then populate with true saved values
  //populatePropertiesDialog(curStory); 
   
  function populatePropertiesDialog(curStory){
    $('#create-story-form').hide();
    //$('#story-properties-form').show();
    $('#story-properties-author').text(curStory['author']);
    $('#story-properties-title').val(curStory['title']);
    $('#story-properties-genre').val(curStory['genre']);
    $('#story-properties-desc').val(curStory['desc']);
    var tags = curStory['tags'];
    var tag = $('#story-properties-tags').val('').val(); 
 for (i=0;i<tags.length;i++) {
      if(i != tags.length-1)
        tag = tag + tags[i].trim() + ', '; 
      else
        tag = tag + tags[i].trim(); 
 }
    $('#story-properties-tags').val(tag);
  }
 
  //Display create story form on user pressed create new story 
  function storyCreation(){
    $('#create-story-form').dialog(
      { autoOpen:true, 
        height: 480, 
        width: 250, 
        title: 'Create New Story',
        position: { my: 'left top', 
                    at: 'left bottom', 
                    of: '.file-menu-option'}, 
      }
    ); 
  } 
   
  function infoStory(){ 
    $('#story-properties-form').dialog(
      { autoOpen:true, 
        height: 480, 
        width: 250, 
        title: 'Story Properties',
        position: { my: 'left top', 
                    at: 'left bottom', 
                    of: '.file-menu-option'}, 
      }
    ); 
  } 

  function deleteStory(){ 
    if( confirm("Are you sure you want to delete this story?") ){
     $.ajax({
      type: "POST",
      url: url,
      data: {DELETE_STORY: curStory['storyId']},
      dataType: "JSON",
      success: function(dataJSON){
       alert(dataJSON);
       var storyIndex = userStories.indexOf(userStories.filter(function(story){
        return story.story_id==curStory['storyId'];})[0]);
       userStories.splice(storyIndex, 1);
       $("[story-index='"+storyIndex+"']").remove();
       if (storyIndex>=userStories.length) {
        --storyIndex;
       } else {
        for (i=storyIndex+1;i<=userStories.length;i++) {
         $("[story-index='"+i+"']").attr('story-index', i-1);
        }
       }
       //load next story
       loadStory(storyIndex);
      },
      error: function(dataJSON){
       alert("couldn't delete");
      }
     });
    }
  }
  
  //load images for each media object
  $('.thumb-img').each(function(index){
  loadThumbImg(this);
  });
  $('.thumb-img').load(function(){
  placeThumbImg(this);
  });
  
  function loadThumbImg(img) {
  $(img).attr('src', '{{ MEDIA_URL }}'+$(img).attr('mediaobject-url'));
  }
  function placeThumbImg(img) {
  var height = $(img).height();
  if (height==120) {
   $(img).css('margin-top', '-10px');
  } else {
   $(img).css('margin-top', 50-height/2+'px');
  }
  }
 
  //add an element from the mini button
  $(document).on('click', '.add-thumb-btn', function(evt){
   evt.stopPropagation();
   var copy = $(this).siblings('.thumb-img').clone();
   copy.css({
   margin: 0,
   'max-height':'100%',
   'max-width':'100%'});

      $(copy).removeClass('thumb-img');
      $(copy).removeClass('media-thumb'); 
      // setup image attributes so things work
      // was having issues with default css and lack 
      // of height/width attr
      copy = addElement(copy);
      height = $(copy).css('height');  
      height = $(copy).css('height').substring(0,height.length-2)
      width = $(copy).css('width');
      width = $(copy).css('width').substring(0,width.length-2)
      $(copy).attr('height', height);
      $(copy).attr('width', width);
      $(copy).css('max-height', '');
      $(copy).css('max-width', '');
      if (copy.width()>=150) {
   var percent = 150/copy.width();
   copy.parent().width(copy.width()*percent);
   copy.parent().height(copy.height()*percent);   
   copy.width(copy.width()*percent);
   copy.height(copy.height()*percent);   
   }else if(copy.width() <= 0){
   var size = 150;
   copy.parent().width(size);
   copy.parent().height(size);   
   copy.width(size);
   copy.height(size);   
      }
      curMediaObjects[curPage][copy.attr('mo-id')] = 
                               copy.attr('mediaobject-url');
  });
 
  $(document).on('click', '.delete-thumb-btn', 
    function(evt){
      alert("deleting image from personal library");      
      deleteImageFromPL($(this).parent().find('img').attr('mo-id'), 
         $(this).parent().parent());
    }
  );
  function deleteImageFromPL(moId, $elem){
    $.ajax({
    type: "GET",
    url: '/medialibrary/personal_library_search/',
    data: {DELETE_MEDIAOBJECT_FROM_PERSONAL_LIBRARY:'True', 
                 MEDIAOBJECT_ID:parseInt(moId) },   
    success: function(data){
              $elem.remove(); 
    },
    error: function(data){
     alert("something went wrong");
    }
   });
  }
  
  //take focus away from any objects when clicking outside
  //use evt.stopPropagation to prevent unfocus when clicking on element
  $('#builder-pane').mousedown(function(evt){
    if ($(evt.target).attr('id')=='builder-pane') {
      unfocusPageBuilder();
      $('#text-entry').sodiio('textEntry', {'clear':true}); 
      if( typeof(moId) != 'undefined' ){
        deleteImageFromPL(moId); 
      }
    }
  });
 
  
  //TODO: this should be incorporated into pageBuilder.js 
  //add a media object to the builder pane
  function addElement(elem){
    unfocusPageBuilder();
    var pbMo = $('#builder-pane').pageBuilder('addElementToPage', elem);
    if( !pbMo.is('div') ){
      setFocusOn(pbMo.parent());
      pbMo.parent().css('padding', '0');
      pbMo.parent().draggable({cancel:''}); 
      pbMo.mousedown(function(evt){
        //prevent builder-pane from unfocusing all, focus on this object
        setFocusOn(pbMo.parent());
      });
    }else{
      setFocusOn(pbMo); 
      pbMo.css('padding', '0');
      pbMo.draggable({cancel:''}); 
      pbMo.mousedown(function(evt){
        //prevent builder-pane from unfocusing all, focus on this object
        setFocusOn(pbMo);
      });
    }
    pbMo.css('margin', '0');
    pbMo.siblings('.delete-pbmo').click(function(){
      removeElement(pbMo);
      setAnimationSelector(0); 
      setTriggerSelector(0); 
      setFontSizeSelector(18); 
      $('#text-entry').text(''); 
      $('#text-entry').val(''); 
    });
    return pbMo;
  }

  $('#text-entry').on('keypress', function(evt){
    $(this).sodiio('textEntry', 
       { 'key-event': 
         {'event-code':evt.which, 'text-output':'.text-box.focus',  },  
       }
    );  
  }); 
 
  $('#text-entry').on('keydown', function(evt){
      if( evt.which == 8 || evt.which == 46 ){ 
        $(this).sodiio('textEntry', 
           { 'key-event': 
             {'event-code':evt.which, 'text-output':'.text-box.focus',  },  
           });  
      }
  }); 
  
  $("#text-entry").on('paste', function(evt) {
    $(this).sodiio('textEntry', { 'replace-newline': true, 
                   'text-output': '.text-box.focus' });  
  }); 
  
  $("#text-entry").on('cut', function() {
    $(this).sodiio('textEntry', { 'replace-newline': true, 
                   'text-output': '.text-box.focus' });  
  });


  //TODO: this should be incorporated into pageBuilder.js 
  //remove a media object from the builder pane
  function removeElement(elem) {
    $("#builder-pane").pageBuilder('removeElementFromPage', elem);
    if (!($('#builder-pane').
                has("[mo-id='"+elem.attr('mo-id')+"']").length>0)) 
    {
      delete curMediaObjects[curPage][elem.attr('mo-id')];
    }
  }
 
  //TODO: this should be incorporated into pageBuilder.js 
  // add focus to currently selected mediaobjec in builder pane
  function setFocusOn($elem) {
    //IF making a connection animat on selection do not 
    //want to unfocus page. 
    if( makeConnectionTrigger ){ 
      // take elem clicked make sure it is an image and 
      // make it the trigger element for the image that is 
      // in focus
      if( $('.text-box.focus').length > 0 ){
        alert('Img-trigger must be an image object. Please select an image.');
        return; 
      } 
      $elem.find('.delete-pbmo').show();
      $elem.addClass('connection').focus();
      setConnectionTrigger($elem); 
      return;  
    } 
    $('.delete-pbmo').hide();
    $('#builder-pane').css('cursor', 'default');
    $elem.find('.delete-pbmo').show();
    $('.pb-media-object').parent().not($elem).removeClass('focus');
    // TEXTBOX MRE
    $('.text-box').not($elem).removeClass('focus').find('.text-box').blur();
    $elem.addClass('focus').focus();
    $('#text-entry').val('');
    var textHtml = $('.text-box.focus').html(); 
    if( textHtml != undefined)  
      $('#text-entry').val( textHtml.replace(/<br>/g,'\n') ); 
    if( $('.text-box.focus').length > 0 ){ 
      $('#text-entry').css('color', $('.text-box.focus').css('color') ); 
      $('#color-input').spectrum('set', $('.text-box.focus').css('color') ); 
      // set font size selector
      var fsize = $('.text-box.focus').css('font-size'); 
      fsize = fsize.substring(0, fsize.length-2); // get rid fo 'px'
      setFontSizeSelector(fsize) 
    }else{
      $('#text-entry').css('color', '#000000');
      $('#color-input').spectrum('set', 'black');
      setFontSizeSelector(18);
    }
    highlightObjectAttributes($elem);

  }
  
  function setConnectionTrigger($triggerElem){
    /* create connection trigger info for elem and 
       set current image focus trigger to 9, which means
       it has a img-trigger
       CURRENTLY NOT WORKING, NEED TO RETHING see bug
    */ 
    $('.focus > img').attr('animate-on', 9); 
    triggerImg = $triggerElem.find('img'); 
    $(triggerImg).attr('trigger-reaction-on', 1); 
    $(triggerImg).attr('reaction-object', 'bus.png');   
  } 

  function setAnimationSelector(action){
    // NO goto action if animation
    setGotoSelector(-1); 
    if( action == undefined) return; 
    var gotoCode = parseInt($('.focus').find('img').attr('anime-code'));
    if(gotoCode == GOTO_ACTION) action = 0; 
    setSelectorValue('#animation-selector', action); 
  }
  function setTriggerSelector(trigger){
    if( trigger == undefined ) return; 
    var gotoCode = parseInt($('.focus').find('img').attr('anime-code'));
    if(gotoCode == GOTO_ACTION) trigger = 0; 
    setSelectorValue('#trigger-selector', trigger); 
  } 
  function setFontSizeSelector(size){
    if( size == undefined ) return; 
    setSelectorValue('#font-size-selector', size); 
  }
  function setGotoSelector(page){
    var gotoCode = parseInt($('.focus').find('img').attr('anime-code'));
    if(gotoCode != GOTO_ACTION) page = -1; 
    setSelectorValue('#goto-selector', page); 
  }
  function setSelectorValue(elem, value){
    $(elem + ' option').removeAttr('selected'); 
    $(elem).children('[value="'+value+'"]').attr('selected', 'selected'); 
    $(elem).val(value)
  }

 //focusing/unfocusing on objects within builder pane
  $('.focus').click(function(){
    unfocusPageBuilder();
  });
  /*
    unfocus all media object on page
  */
  //TODO: this should be incorporated into pageBuilder.js 
  function unfocusPageBuilder() {
    $('.delete-pbmo').hide();
    $('.pb-media-object').parent().removeClass('focus');
    $('.pb-media-object').parent().removeClass('connection');
    // TEXTBOX MRE
    $('.text-box').removeClass('focus');
    $('.color-focus').removeClass('color-focus');
    $('#text-entry').css('color', '#000000');
    $('#color-input').spectrum('set', 'black');
    setFontSizeSelector(18);
    setAnimationSelector(0); 
    setTriggerSelector(0); 
    //makeConnectionTrigger = false; 
  }

 
  // delete image from page using delete key
  $(document).keyup(function(evt){
    if (evt.keyCode===46) {
     var elem = $('.focus').find('.pb-media-object');
     if( elem.length == 0)
         elem = $('.text-box.focus'); 
     if (!(elem.hasClass('text-box'))) {
      removeElement(elem);
     }
    } 
  });

 /* Side story toolbar objects animation action
       pressed. Assign animation to currently selected
       media object.
 */
  $('#animation-selector').click(function(e)
    {
      if( !isFocusValidObject() ){
        setAnimationSelector(0); 
        setTriggerSelector(0); 
        alert('no animations on text currently');
        return; 
      } 
      var mo = $($('.focus')[0]);
      var action = $('#animation-selector option:selected').attr('mo-action');
      setAnimationAndTrigger(mo, action, TOUCH_TRIGGER); 
    }
  );
  
  var makeConnectionTrigger = false; 

  $('#trigger-selector').click(function(e){
    if( !isFocusValidObject() ){
      setAnimationSelector(0); 
      setTriggerSelector(0); 
      alert('no animations on text currently');
      return; 
    } 
    var mo = $($('.focus')[0]);
    var action = $('#animation-selector option:selected').attr('mo-action');
    var trigger = $('#trigger-selector option:selected').attr('mo-trigger');
    if( trigger = 9 ){
      //makeConnectionTrigger = true; 
    }else{
      setAnimationAndTrigger(mo, action, trigger); 
    }

  }); 

  function setAnimationAndTrigger(mo, action, trigger){ 
    var mo = $($('.focus')[0]);
    setAnimation(mo.children('.pb-media-object'), parseInt(action));
    setAttr(mo.children('.pb-media-object'), 
            'animate-on', trigger);
    // DEFUALT TO TOUCH, make sure to set select automatically to touch
    // here...
    $('#trigger-selector option').removeAttr('selected'); 
    $('#trigger-selector').children('[value="'+trigger+'"]')
                          .attr('selected', 'selected'); 
    //now set the display
    $('#trigger-selector').val(trigger);
  }
  function isFocusValidObject(){
    if( $('.text-box.focus').length > 0 ){
      return false; 
    }else if( $('.focus').length <= 0 ){
      return false;
    }
    return true;
  }
  
  $('.mo-layout').click(function(e){
    var action = $(this).attr('mo-action');
    if ($('.focus').length>0) {
      var mo = $($('.focus')[0]);
      if (action.indexOf('index')!==-1) {
        if (action=='up-z-index') {
          mo.next().after(mo);
        } else if (action=='down-z-index') {
          mo.prev().before(mo);
        } else if (action=='top-z-index') {
          $('#builder-pane').append(mo);
        } else if (action=='bottom-z-index') {
          $('#builder-pane').prepend(mo);
        }
      }
    }
  }); 


  var TOUCH_TRIGGER = 1;
  var SOUND_TRIGGER = 2;
  var DRAG = 110;
  var DRAG_GLID = 111;

  $("#animation-run").mousedown(function(evt){
    // WANT TO MAKE SURE NOT TEXT
    if($('.focus').length>0){
      var mo = $($('.focus')[0]);
      el = mo.children('.pb-media-object');  
      //$(el).bind("ANIME_COMPLETE", animationCompleted); 
      $(el).on("ANIME_COMPLETE", animationCompleted); 
      animate(el);
    }
  }); 

  function animationCompleted(){
    //TODO: want to start/stop any elements we dont want to happen
    // while animation is active, think save page. If page saved while
    // animation the x/y, etc. will be wrong. 
    $(this).removeAttr("animated");
  }

  //When MO in pane selected highlight it and setup animation info
  //incase animate pressed
  function highlightObjectAttributes($elem) {
    var pbmo = $elem.find('.pb-media-object');
    if (pbmo.attr('media-type') == 'image') {
      var gotoPage = parseInt(pbmo.attr('goto-page')); 
      if( gotoPage >= 0 ){ 
        //MEE
        setAnimationSelector(0); 
        setTriggerSelector(0); 
        setGotoSelector(gotoPage + 1);
      }else{
        var action = pbmo.attr('anime-code');  
        var trigger = pbmo.attr('animate-on'); 
        setAnimationSelector(action); 
        setTriggerSelector(trigger); 
        setGotoSelector(-1);
      }
    }else{
      setAnimationSelector(0); 
      setTriggerSelector(0); 
      setGotoSelector(-1);
    }
  }


  $('#add-text-mo').click(function(){
    // Adding new text to the page
    var selectedText = $('.text-box.focus').length > 0;  
    if( selectedText ){ 
      //should we copy the selected text and create a new one
      $('#text-entry').sodiio('textEntry', {'clear':true}); 
      unfocusPageBuilder();
      alert('Please enter new text in the text area below the add button to be added to the page.'); 
      return; 
    }
    if( $('#text-entry').val().length == 0 ){
      alert('Please first enter text in the text area below the add button to be added to the page.'); 
      return; 
    }
     
    var elem = $("<div class='text-box focus'"+
                            " fstyle='sans_serif' " + 
       "pmo-id='-1' color='black' media-type='text'></div>");
    $('#text-entry').sodiio('textEntry', {'add-text': true,
                            'text-output':elem, 'font-size': 18 }); 
    setTimeout(function(){
      // need a little time for text-entry to add text correctly
      addElement(elem);
      $(elem).addClass('focus'); 
    }, 100); 
  });  
  
  $('#delete-text').click(function(){
    var selectedText = $('.text-box.focus').length > 0;  
    if( selectedText ){
      var c = confirm('Delete currently selected text object'); 
      if( c ){ 
        removeElement( $('.text-box.focus') );
        $('#text-entry').text('').val(''); 
      }
    }
  }); 

  //creating a textbox
  function addTextbox(){  
    unfocusPageBuilder();
    $('#builder-pane').addClass('add-text-mo');
    $('#builder-pane').mouseenter(function(){
      if ($(this).hasClass('add-text-mo')) {
        $(this).css('cursor', 'text');
      }
    });
     
    //this class will stay on button until text is entered
    //$(this).unbind('mouseenter mouseleave');
    //$(this).addClass('active-btn');
    
    $('#builder-pane').one('click', function(evt){
      //where we add the actual text media object to the page
      if ($(this).hasClass('add-text-mo')) {
        var elem = $("<div class='text-box'"+
                                " fstyle='sans_serif' " + 
           "pmo-id='-1' color='black' media-type='text'></div>");
        var textbox = addElement(elem);
        //textbox.parent().css({
        textbox.css({
            cursor: 'move',
            position:'absolute',
            top:evt.offsetY,
            left:evt.offsetX,}
        ).mousedown(function(){ setFocusOn($(this)) });
        textbox.focus().css('cursor', 'text');
        textbox.keydown(function(e){
          if (e.keyCode===13) {
           e.preventDefault();
           $(this).blur();
          }
        });
        $(this).removeClass('add-text-mo');
      }
    });

  }// end addTextbox
    

 //delete bottom margins from last row of media
  $('.thumb').each(function(){
   if ($(this).index()/7>=parseInt($('.thumb').length/7)) {
    $(this).css('margin-bottom', '0');
   }
  });

  var curPage = 0;
  function updateTotalNumberPages(pages){
    $('#story-total-pages').text(' / ' + pages);
  }

  function updateCurrentPageNav(page){
    $('#story-current-page').val(page);
  } 
  
  $('#story-prev-page').click(
    function(){
      if (validPageNumber(curPage - 1)) {
        savePage();
        updateCurrentPageNav(curPage);
        layoutStoryPage(--curPage);
        setGotoSelector(-1);
      } 
    }
  ); 

  $('#story-next-page').click(
    function(){
      if (validPageNumber(curPage + 1)) {
        savePage();
        updateCurrentPageNav(curPage);
        layoutStoryPage(++curPage);
        setGotoSelector(-1);
      }
    }
  ); 
 
  $('#story-current-page').keydown(
    function(e){
      if(e.keyCode == 13){
        e.preventDefault();
        var page = parseInt($('#story-current-page').val()) -1;
        if(validPageNumber(page) ){
          savePage();
          curPage = page;
          //TODO: need to rework curPage, need to auto 
          //NEED save page when user enters page number
          layoutStoryPage(curPage);
          updateCurrentPageNav(curPage+1);
        }else{
            //Give error
        }
      }
    }
  ); 

  function validPageNumber(pageNumber){
    if( curStoryPages.length == 0) {
      return false; 
    }else if( curStoryPages.length <= pageNumber || pageNumber < 0){
       //TODO: user is at end of story, go back to beginning. 
      return false; 
    }else if(isNaN(pageNumber)){
      return false;
    }else{
      return true;
    }  
  }

  function saveStoryProps(){
    var sData = storyProps($('#story-properties-form'));
    sData['id'] = curStory['storyId'];
    var jsonData = $.toJSON(sData); 
  
    $.ajax({
      type: "POST",
      url: url,
      data: {SAVE_PROPS: jsonData},
      dataType: "JSON",
      success: function(dataJSON) {
                   alert('Story properties updated.');
      },
      error: function(dataJSON) {
       alert('noo!');
      }
     
    });
  }
 
  function storyProps($form) {
    if ($form.attr('id')=='story-properties-form') { 
      var name = '#story-properties-';
    }else { var name = '#create-story-'; }
    
    var sData = {'title': $form.find(name+'title').val(), 
                  'author': $form.find(name+'author').val(), 
                  'genre': $form.find(name+'genre').val(),
                  'description': $form.find(name+'desc').val(),
                  'tags': [$form.find(name+'tags').val().trim()] }; 
                  
    for (i=0;i<$('.tag').length;i++) {
      sData['tags'].unshift($($(name+'tags-wrapper').find('.tag')[i]).text().trim());
    }
    sData['tags'] = sData['tags'].join();
    return sData;
  }

  $('#font-size-selector').click(function(e)
    {
      var elem = $('.focus.text-box'); 
      if( elem.length == 0 ){ 
        return 0;
      } 
      var size = $('#font-size-selector option:selected').val();
      if( validTextSize(size) ){
        $(elem).css('font-size', size+'px');
      } 
    }
  );
 
  
  function validTextSize(size){
    var elem = $('.focus textarea');
    var defaultFontSize = 18; 
    if( size <= 0 || size > 144 || isNaN(size)){
      alert('Invalid font size, resetting to default 24px size.');
      $(elem).css('font-size', defaultFontSize + 'px');
      setFontSizeSelector(defaultFontSize); 
      return false;
    } 
    return true; 
  } 
 
  $("#font-style-menu").click(function(){
      //alert($("#font-style-menu option:selected").val());
      elem = $('.focus textarea'); 
      if( elem.length == 0 )
          return;
      style = $("#font-style-menu option:selected").val(); 
      $(elem).css('font-family', style);
      $(elem).attr('fstyle', style); 
  }); 

  
  //used for forms to show form area title   
  $(".default-text").focusout(function(){
    if (($(this).val().length) <= 0) {
        $(this).val($(this).attr('default-text'));
        $(this).css("color", "grey");
    }
  });
  $(".default-text").focusin(function(){
    if (($(this).val().length) > 0){
      if( $(this).val() == $(this).attr('default-text') ){  
        $(this).val("");
        $(this).css("color", "black");
      }
    }  
  }); 

    // update images 
  function updateImagePage(page){
    //user must be logged in
    currentPage = page; 
    searchTerm = '';
    $.ajax({
      type: "GET",
      url: '/medialibrary/personal_library_search/',
      data: {SEARCH_PAGE_CHANGE:'True', 
                 SEARCH_TERM:searchTerm, 
                 PAGE_NUMBER:parseInt(currentPage)},
      success: function(data){
        tmp = $.evalJSON(data);
        mediaObjects = $.evalJSON(tmp['media_objects']);
        updateMediaObjects(mediaObjects);
        pconfig['start'] = currentPage; 
        $("#jpaginate").paginate(pconfig);
      },
      error: function(data){
        alert("something went wrong");
      }
    });
  }

  function updateMediaObjects(mediaObjects){
    var numObjs = mediaObjects.length; 
    //remove all of the current images
    $('.thumb').remove(); 
    for(var i=0; i < numObjs; i++){
      $elem = $("<div class='thumb'><div class='thumb-img-box'>"+
       "<div class='delete-thumb-btn'>X</div>" + 
       "<img src='' " +
       " class='thumb-img media-object media-thumb' " +
       " pane='false' media-type='image' pmo-id='-1' " +
       " mo-id=" +mediaObjects[i].pk +
       " mediaobject-url="+mediaObjects[i]['fields']['url'] +
       " </img>" + 
       "<div class='add-thumb-btn'>add</div>" + 
       "</div></div>" );  
       $('#mediabox').append($elem);
    }

    $('.thumb-img').each(function(index){
       loadThumbImg(this);
    });
    $('.thumb-img').load(function(){
       placeThumbImg(this);
    });
   
  } // end updateMediaObjedts
  
  var page = 0
  
  $('#test-image-update').click(
    function(){
     updateImagePage(++page); 
    }
  );

  var pconfig = { }; 
  function getTotalNumPagesPL(){
    $.ajax({
        type:"GET", 
        dataType: 'json',
        url: '/medialibrary/personal_library_search/',
        data: {TOTAL_NUMBER_OF_PAGES: "IMAGES"}, 
        success: function(numPages){ 
              pconfig = {
              count: numPages,
              start: 1,
              display: 10,
              border: false,
              text_color: '#79B5E3',
              background_color: 'none',    
              text_hover_color: '#2573AF',
              background_hover_color  : 'none', 
              images: false,
              mouse: 'press',
              onChange: updateImagePage
            };
 
            $("#jpaginate").paginate(pconfig);
        }, 
        error: function(data){
            alert('unable to get number of pages'); 
        } 
     }) ;
  };  

  getTotalNumPagesPL(); 

  $('#progress-dialog').dialog(
    { autoOpen:false, 
      height: 300, 
      width: 300, 
      title: 'Please Wait', 
    }

  );

//// upload image form
  $('#upload-image-form').validate({
      rules: {
          mo_tags:{
            required:true   
          },
          upload_image: {
            required: true, accept: "png"  
            //required: true, accept: "png|jpe?g"  
          }
      },
      
      messages: {
          mo_tags:{
              required: "Please enter tags"
          },
          upload_image: {
              //accept: "Only jpg and png extensions are allowed",
              accept: "Only png extensions are allowed currently, soon JPG and SVG will be allowed.",
              required: "Please upload an image."
          }
      }
  });

  $.validator.addMethod("acceptImageTypes", $.validator.methods.accept, "Selected File must be an image.");

  $.validator.addClassRules("#upload-image-form", {
    acceptImageTypes: "jpg|png|gif"
  });

  $("#upload-image-dialog").dialog({
      autoOpen:false,
      height:400,
      width:300,
      resizable:false,
      modal:true,
      buttons: {
          "Upload":function() {
              valid = false;
              valid = $('#upload-image-form').validate().form();
              if (valid){
                $("#upload-image-form").submit();
              }
          },
          Cancel: function() {

              $(this).dialog("close");
          }
      },
      close:function() {
      }
  }); 
  
  $("#upload-media-button").click(function(e){
      e.preventDefault();
      if( user == "" ){
        alert("you must first login to save media to personal library");
        return 0;
      }
     // alert("Came just before opening");
     //the dialog opening works now. wasn't opening because of enctype?
     // return false;

      upload_url = $('#image-upload-url').val();
      //this should be improved..should be asynchronous and within the page, like preview-link button for previewing images.
    // window.location=upload_url;  
      $.ajax({
          type: "GET",
          url: upload_url,
          data: {},
          success: function(data){
            // alert("GET request went in and came back");
             tmp = $.evalJSON(data);
             console.log(tmp['form']);
             $("#upload-image-form").html("{% csrf_token %}"+tmp['form']);
             $("#upload-image-form p:first input").attr('size', 8);
             $("#upload-image-dialog").dialog("open");
            }
      }); 
    
  }); 
  
  initializeFeedback( $('#url-info').val() );
  
  
   
  var GOTO_ACTION = 200; 
  $('#goto-selector').click(function(e){
    
    if( $('.text-box.focus').length > 0 ){
      setGotoSelector(-1); 
      alert('Currently only images can have a goto action'); 
      return; 
    } 
    if ($('.focus').length < 1){
      setGotoSelector(-1); 
      alert('First select image.');
      return; 
    }
    var gotoPage = parseInt( $('#goto-selector option:selected').val() )-1; 
    if( gotoPage < 0 ){
      alert('Please select a valid page to go to.'); 
      return; 
    }
    if($(this).children().length <= 2){
      setGotoSelector(-1); 
      alert('Goto allows you to select a page '+
            'to "go to" when a character is touched. '+
            'You need to add more pages before you '+
            'can use this feature.'); 
      return; 
    }

    if( gotoPage == curPage){
      alert('You must select a different page to "go to."'); 
      setGotoSelector(-1); 
      return; 
    }
     
    var $mo = $($('.focus')[0]);
    // NO animation if goto action, trigger is hardcoded 
    // for touch only right now, so default selectors. 
    setAnimationSelector(0); 
    setTriggerSelector(0);
    //BOILERPLATE: refactor
    setAnimation($mo.children('.pb-media-object'), GOTO_ACTION);
    setAttr($mo.children('.pb-media-object'), 
                   'animate-on', TOUCH_TRIGGER);
    setGoto($mo.children('.pb-media-object'), gotoPage);
    //MEE
    setGotoSelector(gotoPage + 1);

  }); 

  var addPageToGotoSelector = function(){
    //length always one greater then highest page b/c of '-'
    var newPage= $('#goto-selector').children().length; 
    var elem = '<option value="'+newPage+'">'+newPage+'</option>'; 
    $('#goto-selector').append(elem); 
  }; 
  
  var deletePageFromGotoSelector = function(){
    $('#goto-selector :last-child').remove();   
  }; 
  
  //called on loading story
  var updateGotoSelector = function(totalNumPages){
    setGotoSelector(-1); 
    var curNumPages = $('#goto-selector').children().length - 1; 
    if( curNumPages == totalNumPages ) return ; 
    if( curNumPages < totalNumPages ){
      for(var i=curNumPages; i<totalNumPages; i++){
        addPageToGotoSelector(); 
      }
    }
    if( curNumPages > totalNumPages ){
      for(var i=curNumPages; i > totalNumPages; i--){
        deletePageFromGotoSelector(); 
      }
    }
  }; 
  
  // MRE
  $('#dropdown-story-menu').on('click', '.file-menu-option', 
    function(){
      var action = $(this).attr('action'); 
      switch(action){
        case 'new':
          storyCreation(); 
          break; 
        case 'open':
          openStory(); 
          break; 
        case 'save':
          //Need to let user know that save took place
          savePage(); 
          break; 
        case 'share':
          shareStory(); 
          break; 
        case 'delete':
          deleteStory(); 
          break; 
        case 'info':
          infoStory(); 
          break; 
      }
    }
  ); 

  $('#dropdown-page-menu').on('click', '.page-menu-option', 
    function(){
      var action = $(this).attr('action'); 
      switch(action){
        case 'new':
          createPage(); 
          break; 
        case 'save':
          savePage(); 
          break; 
        case 'delete':
          deletePage();
          break; 
      }
    }
  ); 
  // MRE get rid of change for new text entry control
  $('#dropdown-text-menu').on('click', '.text-menu-option', 
    function(){
      var action = $(this).attr('action'); 
      switch(action){
        case 'add':
          addTextbox(); 
          break; 
      }
    }
  ); 
  $('#dropdown-media-menu').on('click', '.media-menu-option', 
    function(){
      var action = $(this).attr('action'); 
      switch(action){
        case 'image-library':
          window.location = '/medialibrary/images/';  
          break; 
      }
    }
  );
  $('#dropdown-help-menu').on('click', '.help-menu-option', 
    function(){
      var action = $(this).attr('action'); 
      switch(action){
        case 'about':
          alert('comming soon.');
          break; 
        case 'quick-tutorial':
          //$('#reveal').css('display', 'block');
          $('#reveal-div').reveal({
            animation:'fade', 
            animationspeed: 200, 
            closeonbackgroundclick: true, 
          }); 
          break; 
      }
    }
  ); 
  
  var numThumbs = $('.thumb-img').length; 
  if( numThumbs == 0){
          $('#reveal-div').reveal({
            animation:'fade', 
            animationspeed: 200, 
            closeonbackgroundclick: true    
          }); 
  }
 
  function openStory(){
    $('#user-stories').dialog(
       { autoOpen:true, 
         height: 300, 
         width: 220, 
         position: { my: 'left top', 
                     at: 'left bottom', 
                     of: '.file-menu-option'}, 
         title: 'Open Story', 
       }); 
  } 
  

}); // endjquery $(function(
</script> 

{% endblock %} 


{% block content %}
<div style='float:left;'>
  <span class='section-title'>StoryScape</span>
</div>
<div id='progress-dialog' ><p>Your story is 
  is being created for sharing. This could take up to a minute for
  large stories. This dialog will automatically close when finished.
  Thank you and keep creating!</p>
</div>
<div id='progressbar-wrapper'>
  <div id='progressbar'></div>
</div>

<!-- book builder pane --> 
<div id='storyscape-container'>
 
  <div style='height:520px;'> 
    <div id='builder-pane-container' style='float:left; width:1024px; height:500px; '> 
      <div style='width:720px; float:left'>
        <div id="builder-pane">
        </div> <!-- end builder-pane --> 
        {% include "storyscape/storyline_navigation.html" %} 
      </div>
      {% include "storyscape/side_control_panel.html" %} 
    </div>
  </div>
 
  <div style='height:660px;'> 
  <div id='mediabox' >
    <div id="pages-wrapper" style="width:100%;">
      <div id='pages' 
           style="width:340px; margin-left:240px; margin-right:auto;">
         <div id="jpaginate"> </div>
      </div>
    </div>
    <div id='thumb-wrapper'>
   {% if media_objects|length > 0 %}
     {% for mo in media_objects %}
     <div class="thumb">
       <div class='thumb-img-box'>
       <div class='delete-thumb-btn'><span class='small-text'>X</span></div>
              <img src='' 
                   class='thumb-img media-object media-thumb' 
                   pane='false' media-type="image" pmo-id='-1'
                   mo-id={{ mo.id }} mediaobject-url= {{ mo.url }} /> 
       <div class='add-thumb-btn'><span class='small-text'>add</span></div>
     </div>
      </div>         
      {% endfor %} 
    {% else %}
       <div class="post">
         <div class="post-content">
          <p style="display:block; width:400px; margin-left:auto; margin-right:auto;">Add Images From the 
           <a href="/medialibrary/images/">Media Library</a> 
           or <a href="/medialibrary/images/">Upload</a> your own</p>
         </div>
       </div>
    {% endif %} 
    </div>
  </div>
  </div>

</div> <!-- end of storyscape-container --> 

<input id=user type="hidden" name="{{ user.username }}" />
<input id="url-info" type="hidden"
    value="{% url storyscape %}" /> 
<input id="image-upload-url" type="hidden"
    value="{% url media_image_upload %}" />
{% endblock %}
